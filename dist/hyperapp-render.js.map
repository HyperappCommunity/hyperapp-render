{"version":3,"file":"hyperapp-render.js","sources":["src/index.js"],"sourcesContent":["const styleNameCache = new Map()\nconst uppercasePattern = /([A-Z])/g\nconst msPattern = /^ms-/\n\n// https://www.w3.org/TR/html/syntax.html#void-elements\nconst voidElements = new Set([\n  'area',\n  'base',\n  'br',\n  'col',\n  'embed',\n  'hr',\n  'img',\n  'input',\n  'link',\n  'meta',\n  'param',\n  'source',\n  'track',\n  'wbr',\n])\n\nconst ignoreAttributes = new Set([\n  'key',\n  'innerHTML',\n  '__source', // https://babeljs.io/docs/plugins/transform-react-jsx-source/\n])\n\n// https://www.w3.org/International/questions/qa-escapes#use\nconst escapeRegExp = /[\"&'<>]/g\nconst escapeLookup = new Map([\n  ['\"', '&quot;'],\n  ['&', '&amp;'],\n  [\"'\", '&#39;'],\n  ['<', '&lt;'],\n  ['>', '&gt;'],\n])\n\nfunction escaper(match) {\n  return escapeLookup.get(match)\n}\n\nfunction escapeHtml(value) {\n  if (typeof value === 'number') {\n    // better performance for safe values\n    return '' + value\n  }\n\n  return ('' + value).replace(escapeRegExp, escaper)\n}\n\n// \"backgroundColor\" => \"background-color\"\n// \"MozTransition\" => \"-moz-transition\"\n// \"msTransition\" => \"-ms-transition\"\nfunction hyphenateStyleName(styleName) {\n  return (\n    styleNameCache.get(styleName) ||\n    styleNameCache\n      .set(\n        styleName,\n        styleName\n          .replace(uppercasePattern, '-$&')\n          .toLowerCase()\n          .replace(msPattern, '-ms-'),\n      )\n      .get(styleName)\n  )\n}\n\nfunction stringifyStyles(styles) {\n  let out = ''\n  let delimiter = ''\n  const styleNames = Object.keys(styles)\n\n  for (let i = 0; i < styleNames.length; i++) {\n    const styleName = styleNames[i]\n    const styleValue = styles[styleName]\n\n    if (styleValue != null) {\n      if (styleName === 'cssText') {\n        out += delimiter + styleValue\n      } else {\n        out += delimiter + hyphenateStyleName(styleName) + ':' + styleValue\n      }\n\n      delimiter = ';'\n    }\n  }\n\n  return out || null\n}\n\n// https://www.w3.org/TR/html51/syntax.html#serializing-html-fragments\nfunction renderFragment({ nodeName, attributes, children }, stack) {\n  let out = ''\n  let footer = ''\n\n  if (nodeName) {\n    out += '<' + nodeName\n    const keys = Object.keys(attributes)\n\n    for (let i = 0; i < keys.length; i++) {\n      const name = keys[i]\n      let value = attributes[name]\n\n      if (name === 'style' && value && typeof value === 'object') {\n        value = stringifyStyles(value)\n      }\n\n      if (\n        value != null &&\n        value !== false &&\n        typeof value !== 'function' &&\n        !ignoreAttributes.has(name)\n      ) {\n        out += ' ' + name\n\n        if (value !== true) {\n          out += '=\"' + escapeHtml(value) + '\"'\n        }\n      }\n    }\n\n    if (voidElements.has(nodeName)) {\n      out += '/>'\n    } else {\n      out += '>'\n      footer = '</' + nodeName + '>'\n    }\n  }\n\n  const { innerHTML } = attributes\n\n  if (innerHTML != null) {\n    out += innerHTML\n  }\n\n  if (children.length > 0) {\n    stack.push({\n      childIndex: 0,\n      children,\n      footer,\n    })\n  } else {\n    out += footer\n  }\n\n  return out\n}\n\nfunction resolveNode(node, state, actions) {\n  if (typeof node === 'function') {\n    return resolveNode(node(state, actions), state, actions)\n  }\n\n  return node\n}\n\nexport function renderer(view, state, actions) {\n  const stack = [\n    {\n      childIndex: 0,\n      children: [view],\n      footer: '',\n    },\n  ]\n  let end = false\n  return (bytes) => {\n    if (end) {\n      return null\n    }\n\n    let out = ''\n\n    while (out.length < bytes) {\n      if (stack.length === 0) {\n        end = true\n        break\n      }\n\n      const frame = stack[stack.length - 1]\n\n      if (frame.childIndex >= frame.children.length) {\n        out += frame.footer\n        stack.pop()\n      } else {\n        const node = resolveNode(frame.children[frame.childIndex++], state, actions)\n\n        if (node != null && typeof node !== 'boolean') {\n          if (node.pop) {\n            // array\n            stack.push({\n              childIndex: 0,\n              children: node,\n              footer: '',\n            })\n          } else if (node.attributes) {\n            // element\n            out += renderFragment(node, stack)\n          } else {\n            // text node\n            out += escapeHtml(node)\n          }\n        }\n      }\n    }\n\n    return out\n  }\n}\n\nexport function renderToString(view, state, actions) {\n  return renderer(view, state, actions)(Infinity)\n}\n\nexport function withRender(nextApp) {\n  return (initialState, actionsTemplate, view, container) => {\n    const actions = nextApp(\n      initialState,\n      Object.assign({}, actionsTemplate, { getState: () => (state) => state }),\n      view,\n      container,\n    )\n\n    actions.toString = () => renderToString(view, actions.getState(), actions)\n\n    return actions\n  }\n}\n"],"names":["styleNameCache","Map","uppercasePattern","msPattern","voidElements","Set","ignoreAttributes","escapeRegExp","escapeLookup","escaper","match","get","escapeHtml","value","replace","hyphenateStyleName","styleName","set","toLowerCase","stringifyStyles","styles","out","delimiter","styleNames","Object","keys","i","length","styleValue","renderFragment","stack","nodeName","attributes","children","footer","name","has","innerHTML","push","resolveNode","node","state","actions","renderer","view","end","bytes","frame","childIndex","pop","renderToString","Infinity","withRender","nextApp","initialState","actionsTemplate","container","assign","toString","getState"],"mappings":"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"}