{"version":3,"file":"hyperapp-render.js","sources":["src/index.js"],"sourcesContent":["const cache = new Map()\nconst uppercasePattern = /([A-Z])/g\nconst msPattern = /^ms-/\n\n// https://www.w3.org/TR/html/syntax.html#void-elements\nconst voidElements = new Set([\n  'area',\n  'base',\n  'br',\n  'col',\n  'embed',\n  'hr',\n  'img',\n  'input',\n  'link',\n  'meta',\n  'param',\n  'source',\n  'track',\n  'wbr',\n])\n\n// https://www.w3.org/International/questions/qa-escapes#use\nconst escapeRegExp = /[\"&'<>]/g\nconst escapeLookup = new Map([\n  ['\"', '&quot;'],\n  ['&', '&amp;'],\n  [\"'\", '&#39;'],\n  ['<', '&lt;'],\n  ['>', '&gt;'],\n])\n\nfunction escaper(match) {\n  return escapeLookup.get(match)\n}\n\nfunction escapeHtml(value) {\n  return String(value).replace(escapeRegExp, escaper)\n}\n\n// \"backgroundColor\" => \"background-color\"\n// \"MozTransition\" => \"-moz-transition\"\n// \"msTransition\" => \"-ms-transition\"\nfunction hyphenateStyleName(styleName) {\n  if (!cache.has(styleName)) {\n    cache.set(\n      styleName,\n      styleName\n        .replace(uppercasePattern, '-$&')\n        .toLowerCase()\n        .replace(msPattern, '-ms-'),\n    )\n  }\n  return cache.get(styleName)\n}\n\nfunction stringifyStyles(styles) {\n  let serialized = ''\n  let delimiter = ''\n  const styleNames = Object.keys(styles)\n  for (let i = 0, len = styleNames.length; i < len; i++) {\n    const styleName = styleNames[i]\n    const styleValue = styles[styleName]\n\n    // keep in sync with https://github.com/hyperapp/hyperapp/blob/1.1.0/src/index.js#L135\n    if (styleValue != null) {\n      serialized += delimiter + hyphenateStyleName(styleName) + ':' + styleValue\n      delimiter = ';'\n    }\n  }\n  return serialized || null\n}\n\nfunction renderAttribute(name, value) {\n  let val = value\n  if (name === 'style' && val) {\n    val = stringifyStyles(val)\n  }\n  if (val == null || val === false) {\n    return ''\n  }\n  if (val === true) {\n    return name\n  }\n  return name + '=\"' + escapeHtml(val) + '\"'\n}\n\nfunction renderFragment(node, stack) {\n  // keep in sync with https://github.com/hyperapp/hyperapp/blob/1.1.0/src/index.js#L150\n  if (node == null) {\n    return ''\n  }\n\n  const attributes = node.attributes\n  if (!attributes) {\n    // text node\n    return escapeHtml(node)\n  }\n\n  const tag = node.nodeName\n  let out = ''\n  let footer = ''\n  if (tag) {\n    // https://www.w3.org/TR/html51/syntax.html#serializing-html-fragments\n    out += '<' + tag\n    const keys = Object.keys(attributes)\n    for (let i = 0, len = keys.length; i < len; i++) {\n      const name = keys[i]\n      const value = attributes[name]\n\n      // keep in sync with https://github.com/hyperapp/hyperapp/blob/1.1.0/src/index.js#L131\n      if (name !== 'key' && name !== 'innerHTML' && typeof value !== 'function') {\n        const attr = renderAttribute(name, value)\n        if (attr) {\n          out += ' ' + attr\n        }\n      }\n    }\n\n    if (voidElements.has(tag)) {\n      out += '/>'\n    } else {\n      out += '>'\n      footer = '</' + tag + '>'\n    }\n  }\n\n  const html = attributes.innerHTML\n  if (html != null) {\n    out += html\n  }\n\n  const children = node.children\n  if (children.length > 0) {\n    stack.push({\n      childIndex: 0,\n      children,\n      footer,\n    })\n  } else {\n    out += footer\n  }\n\n  return out\n}\n\nexport function renderer(node) {\n  const stack = [\n    {\n      childIndex: 0,\n      children: [node],\n      footer: '',\n    },\n  ]\n  let end = false\n  return (bytes) => {\n    if (end) {\n      return null\n    }\n    let out = ''\n    while (out.length < bytes) {\n      if (stack.length === 0) {\n        end = true\n        break\n      }\n      const frame = stack[stack.length - 1]\n      if (frame.childIndex >= frame.children.length) {\n        out += frame.footer\n        stack.pop()\n      } else {\n        const child = frame.children[frame.childIndex++]\n        out += renderFragment(child, stack)\n      }\n    }\n    return out\n  }\n}\n\nexport function renderToString(node) {\n  return renderer(node)(Infinity)\n}\n\nexport function render(app) {\n  return (initialState, actionsTemplate, view, container) =>\n    app(\n      initialState,\n      Object.assign({}, actionsTemplate, {\n        toString: () => (state, actions) => renderToString(view(state, actions)),\n      }),\n      view,\n      container,\n    )\n}\n"],"names":["cache","Map","uppercasePattern","msPattern","voidElements","Set","escapeRegExp","escapeLookup","escaper","match","get","escapeHtml","value","String","replace","hyphenateStyleName","styleName","has","set","toLowerCase","stringifyStyles","styles","serialized","delimiter","styleNames","Object","keys","i","len","length","styleValue","renderAttribute","name","val","renderFragment","node","stack","attributes","tag","nodeName","out","footer","attr","html","innerHTML","children","push","renderer","end","bytes","frame","childIndex","pop","child","renderToString","Infinity","render","app","initialState","actionsTemplate","view","container","assign","state","actions"],"mappings":"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"}